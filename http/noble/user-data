#cloud-config
autoinstall:
  version: 1
  locale: en_US
  keyboard:
    layout: us
  # identity:
  #   hostname: packerubuntu
  #   username: admin
  #   password: $6$OJcm.7n9o62RqLEl$iYVzReRGY6ExYbPb6ql/xeo56y5IUVR/GjN7JMlO.C3hsQwxgwmFe9M0J3Ea2N.wzbHraZzr69adTDvA0WeyF/
  ssh:
    install-server: yes
      # authorized-keys:
      #   - $key
    allow-pw: yes
    # snaps:
    #     - name: go
    #       channel: 1.20/stable
    #       classic: true
    # debconf-selections: |
    #     bind9      bind9/run-resolvconf    boolean false
    # packages:
    #     - libreoffice
    #     - dns-server^
  user-data:
    disable_root: false
    preserve_hostname: false
    hostname: packerubuntu
    package_upgrade: true
    timezone: Europe/Berlin
    chpasswd:
      expire: false
      users:
        - {name: root, password: packerubuntu, type: text}
    ssh_pwauth: false
    users:
      - name: admin
        passwd: $6$OJcm.7n9o62RqLEl$iYVzReRGY6ExYbPb6ql/xeo56y5IUVR/GjN7JMlO.C3hsQwxgwmFe9M0J3Ea2N.wzbHraZzr69adTDvA0WeyF/
        groups: [adm, cdrom, dip, plugdev, lxd, sudo]
        lock_passwd: false
        sudo: ALL=(ALL) NOPASSWD:ALL
        shell: /bin/bash
  late-commands:
    #- echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/ubuntu
    #- sed -ie 's/GRUB_CMDLINE_LINUX=.*/GRUB_CMDLINE_LINUX="net.ifnames=0 ipv6.disable=1 biosdevname=0 elevator=noop"/' /target/etc/default/grub
    - sed -ie 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /target/etc/ssh/sshd_config
    - sed -ie 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /target/etc/ssh/sshd_config
    - sed -ie 's/#AllowAgentForwarding yes/AllowAgentForwarding yes/' /target/etc/ssh/sshd_config
  #  - curtin in-target -- update-grub2
    # virtual package is required for some cloud images. Lack of it causes failure in communication.
#    - curtin in-target -- apt-get -y install linux-cloud-tools-virtual||true
 #   - curtin in-target -- systemctl enable qemu-guest-agent
    # late-commands:
    #     - sed -ie 's/GRUB_TIMEOUT=.*/GRUB_TIMEOUT=30/' /target/etc/default/grub
    # error-commands:
    #     - tar c /var/log/installer | nc 192.168.0.1 1000

#   user-data:
#     preserve_hostname: false
#     hostname: packerubuntu
#     package_upgrade: true
#     timezone: Europe/Berlin
#     chpasswd:
#       expire: true
#       list:
#         - admin:packerubuntu
#         - user1:packerubuntu
#     users:
#       - name: admin
#         passwd: $6$OJcm.7n9o62RqLEl$iYVzReRGY6ExYbPb6ql/xeo56y5IUVR/GjN7JMlO.C3hsQwxgwmFe9M0J3Ea2N.wzbHraZzr69adTDvA0WeyF/
#         groups: [adm, cdrom, dip, plugdev, lxd, sudo]
#         lock_passwd: false
#         sudo: ALL=(ALL) NOPASSWD:ALL
#         shell: /bin/bash
#       - name: user1
#         plain_text_passwd: packerubuntu
#         lock_passwd: false
#         shell: /bin/bash
